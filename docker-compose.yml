# =============================================================================
# TerraCost - IaC Cost Intelligence Platform
# =============================================================================
# 
# Start full stack:  docker-compose up -d
# View logs:         docker-compose logs -f
# Stop:              docker-compose down
#
# Run pricing update manually:
#   docker-compose run --rm pricing-update
#
# =============================================================================

services:
  # =========================
  # ClickHouse Database
  # =========================
  clickhouse:
    image: clickhouse/clickhouse-server:24.1-alpine
    container_name: terracost-clickhouse
    environment:
      CLICKHOUSE_DB: terracost
      CLICKHOUSE_USER: terracost
      CLICKHOUSE_PASSWORD: ${CH_PASSWORD:-terracost_dev}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - clickhouse-logs:/var/log/clickhouse-server
      - ./db/clickhouse/001_pricing_schema.sql:/docker-entrypoint-initdb.d/001_pricing_schema.sql:ro
      - ./db/clickhouse/users.xml:/etc/clickhouse-server/users.d/users.xml:ro
    ports:
      - "8123:8123"
      - "9000:9000"
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query 'SELECT 1' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - terracost-network
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  # =========================
  # Decision API Server
  # =========================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: cli
    image: terracost:latest
    container_name: terracost-api
    depends_on:
      - clickhouse
    environment:
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=9000
      - CLICKHOUSE_DATABASE=terracost
      - CLICKHOUSE_USER=terracost
      - CLICKHOUSE_PASSWORD=${CH_PASSWORD:-terracost_dev}
      - TERRACOST_LOG_LEVEL=info
      - TERRACOST_PORT=8080
      - OPA_ENDPOINT=http://opa:8181
    ports:
      - "8080:8080"
    networks:
      - terracost-network
    command: ["serve", "--port", "8080"]
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # =========================
  # Open Policy Agent (OPA)
  # =========================
  opa:
    image: openpolicyagent/opa:latest
    container_name: terracost-opa
    command:
      - "run"
      - "--server"
      - "--addr=:8181"
      - "--log-level=info"
      - "/policies"
    volumes:
      - ./decision/policy/opa:/policies:ro
    ports:
      - "8181:8181"
    networks:
      - terracost-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8181/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # =========================
  # Frontend UI
  # =========================
  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=http://localhost:8080
    image: terracost-ui:latest
    container_name: terracost-ui
    depends_on:
      - api
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8080
      - BACKEND_API_URL=http://api:8080
    ports:
      - "3000:3000"
    networks:
      - terracost-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # =========================
  # Pricing Pipeline (MANUAL)
  # Run: docker-compose run --rm pricing-update
  # =========================
  pricing-update:
    build:
      context: .
      dockerfile: Dockerfile
      target: cli
    image: terracost:latest
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=9000
      - CLICKHOUSE_DATABASE=terracost
      - CLICKHOUSE_USER=terracost
      - CLICKHOUSE_PASSWORD=${CH_PASSWORD:-terracost_dev}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-us-east-1}
    volumes:
      - pricing-backups:/app/pricing-backups
    networks:
      - terracost-network
    command: ["pricing", "update", "--provider", "aws", "--region", "us-east-1"]
    profiles:
      - manual

volumes:
  clickhouse-data:
  clickhouse-logs:
  pricing-backups:

networks:
  terracost-network:
    driver: bridge
